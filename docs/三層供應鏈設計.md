# 多層級供應鏈 - 銷售與進貨流程

## 架構說明

支援三層至五層（或更多）的經銷架構，透過 `parentUserId`（上線）建立金三角層級：

```
第一線 總經銷商（ADMIN）
    │ 進貨來源：外部供應商
    │ 進貨對象：第二線
    ▼
第二線 經銷商（Stockist，上線=第一線）
    │ 進貨來源：第一線
    │ 進貨對象：第三線
    ▼
第三線 經銷商（Stockist，上線=第二線）
    │ 進貨來源：第二線
    │ 進貨對象：第四線
    ▼
第四線 經銷商（Stockist，上線=第三線）
    │ 進貨來源：第三線
    │ 進貨對象：第五線
    ▼
第五線 顧客（Customer，上線=第四線）
    進貨來源：第四線
```

**原則**：每一線向自己的**上線**（parentUserId）進貨。

## 流程說明

### 1. 顧客向經銷商購買（Orders）
- 顧客下單 → 經銷商出貨
- 庫存：經銷商庫存 **減少**
- 金額：售價（收入）

### 2. 經銷商向上線進貨（進貨單 - 向上線進貨）
- 經銷商建立進貨單，勾選「向上線進貨」或「向總經銷商進貨」
- 來源：自己的上線（parentUserId）或選擇的總經銷商
- 確認收貨時：**上線庫存減少** → **本線庫存增加**
- 第二線向第一線、第三線向第二線、第四線向第三線…依此類推

### 3. 經銷商向外部供應商進貨（進貨單 - 一般進貨）
- 經銷商建立進貨單，不勾選「向上線進貨」
- 填寫供應商名稱
- 確認收貨時：僅 **經銷商庫存增加**（假設從外部到貨）

## 典型情境

**情境**：顧客向經銷商 A 購買 10 件產品 X

1. 經銷商 A 檢查庫存 → 不足
2. 經銷商 A 建立進貨單，勾選「向上線進貨」，向上線採購 50 件
3. ADMIN 確認收貨 → ADMIN 庫存 -50，經銷商 A 庫存 +50
4. 經銷商 A 完成顧客訂單 → 經銷商 A 庫存 -10

## 系統欄位

| 進貨單欄位 | 說明 |
|-----------|------|
| `fromUserId` | 向上線進貨時，來源使用者 ID（上線，可為 ADMIN 或任一層經銷商） |
| `userId` | 收貨人（經銷商） |
| `supplierName` | 供應商名稱（外部）或「總經銷商」 |

## 權限

- **ADMIN**：可建立進貨單給任何經銷商，可向自己（總經銷商）出貨給經銷商
- **STOCKIST**：可建立進貨單給自己，可選擇向上線或總經銷商進貨

## 設定多層級

在「使用者」管理中，為每位經銷商設定 **上線（parentUserId）**：
- 第一線：無上線（頂層）
- 第二線：上線 = 第一線
- 第三線：上線 = 第二線
- 第四線：上線 = 第三線
- 第五線（顧客）：上線 = 第四線

建立進貨單時，勾選「向上線進貨」並選擇「上線」即可向直屬上線採購。
