# 多層級供應鏈 - 銷售與進貨流程

## 架構說明

支援三層至五層（或更多）的經銷架構，透過 `parentUserId`（上線）建立金三角層級：

```
第一線 總經銷商（ADMIN）
    │ 進貨來源：台灣（外部供應商）← 總經銷商需向台灣訂貨及進貨
    │ 進貨對象：第二線
    ▼
第二線 經銷商（Stockist，上線=第一線）
    │ 進貨來源：第一線
    │ 進貨對象：第三線
    ▼
第三線 經銷商（Stockist，上線=第二線）
    │ 進貨來源：第二線
    │ 進貨對象：第四線
    ▼
第四線 經銷商（Stockist，上線=第三線）
    │ 進貨來源：第三線
    │ 進貨對象：第五線
    ▼
第五線 顧客（Customer，上線=第四線）
    進貨來源：第四線
```

**原則**：每一線向自己的**上線**（parentUserId）進貨。

## 流程說明

### 1. 顧客向經銷商購買（Orders）
- 顧客下單 → 經銷商出貨
- 庫存：經銷商庫存 **減少**
- 金額：售價（收入）

### 2. 經銷商向上線進貨（進貨單 - 向上線進貨）
- 經銷商建立進貨單，勾選「向上線進貨」或「向總經銷商進貨」
- 來源：自己的上線（parentUserId）或選擇的總經銷商
- 確認收貨時：**上線庫存減少** → **本線庫存增加**
- 第二線向第一線、第三線向第二線、第四線向第三線…依此類推

### 3. 總經銷商向台灣訂貨及進貨（進貨單 - 外部供應商）
- **總經銷商**建立進貨單，不勾選「向上線進貨」（總經銷商無上線）
- 供應商名稱填寫「台灣」或「Taiwan」
- 收貨人選擇自己（總經銷商）
- 確認收貨時：**總經銷商庫存增加**（貨物從台灣到貨）
- 總經銷商庫存充足後，才能供貨給下線經銷商

### 4. 經銷商向外部供應商進貨（進貨單 - 一般進貨）
- 經銷商建立進貨單，不勾選「向上線進貨」
- 填寫供應商名稱
- 確認收貨時：僅 **經銷商庫存增加**（假設從外部到貨）

## 典型情境

**情境一**：總經銷商向台灣進貨

1. 總經銷商建立進貨單，供應商填「台灣」，收貨人為自己
2. 台灣發貨後，總經銷商在進貨單詳情頁點「確認收貨」
3. 總經銷商庫存增加

**情境二**：顧客向經銷商 A 購買 10 件產品 X

1. 經銷商 A 檢查庫存 → 不足
2. 經銷商 A 建立進貨單，勾選「向上線進貨」，向上線（總經銷商）採購 50 件
3. 總經銷商確認收貨 → 總經銷商庫存 -50，經銷商 A 庫存 +50
4. 經銷商 A 完成顧客訂單 → 經銷商 A 庫存 -10

**供應鏈起點**：總經銷商需先向台灣訂貨及進貨，才有庫存可供應給下線經銷商。

## 系統欄位

| 進貨單欄位 | 說明 |
|-----------|------|
| `fromUserId` | 向上線進貨時，來源使用者 ID（上線，可為 ADMIN 或任一層經銷商） |
| `userId` | 收貨人（經銷商） |
| `supplierName` | 供應商名稱（外部）或「總經銷商」 |

## 權限

- **ADMIN**：可建立進貨單給任何經銷商，可向自己（總經銷商）出貨給經銷商
- **STOCKIST**：可建立進貨單給自己，可選擇向上線或總經銷商進貨

## 設定多層級

在「使用者」管理中，為每位經銷商設定 **上線（parentUserId）**：
- 第一線：無上線（頂層）
- 第二線：上線 = 第一線
- 第三線：上線 = 第二線
- 第四線：上線 = 第三線
- 第五線（顧客）：上線 = 第四線

建立進貨單時，勾選「向上線進貨」並選擇「上線」即可向直屬上線採購。

---

## 規定程序（SOP）

### 訂單建立規則

1. **下線只能向直屬上線下單**
   - 經銷商建立訂單時，買方選項僅顯示其直屬下線（parentUserId = 自己）
   - Admin 建立訂單時，選擇買方後，賣方自動限制為買方的直屬上線（parentUserId）
   - 買方有上線時，賣方必須為其 parentUserId

2. **進貨單可從待出貨訂單帶入**
   - 建立進貨單時，點「從待出貨訂單帶入」可自動彙總該收貨人（賣方）的待處理訂單品項與數量
   - 依此建立進貨單向上線補貨，層層傳遞至總經銷商

### 完整流程範例

1. 下線 C 向 下線 A 下單 10 盒 → 訂單建立（PENDING）
2. 下線 A 建立進貨單，點「從待出貨訂單帶入」→ 品項自動帶入，向 經銷商 B 進貨
3. 經銷商 B 建立進貨單，點「從待出貨訂單帶入」→ 向 總經銷商 進貨
4. 總經銷商 建立進貨單，供應商填「台灣」→ 向台灣訂貨及進貨
5. 總經銷商 確認收貨 → 經銷商 B 確認收貨 → 下線 A 確認收貨
6. 下線 A 完成訂單（COMPLETED）→ 下線 C 收到貨
